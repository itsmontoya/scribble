name: Release (open bump PR)

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: write
  issues: read

concurrency:
  group: release-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare release bump PR
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Decide bump from PR labels (via API)
        id: decide
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # Pull Request is also an Issue; labels live on the issues endpoint.
          label_names="$(gh api "/repos/${REPO}/issues/${PR_NUMBER}" --jq '.labels[].name' || true)"

          echo "Labels on PR #${PR_NUMBER}:"
          echo "${label_names:-<none>}"

          bump=""
          echo "$label_names" | grep -qx "major" && bump="major" || true
          if [ -z "$bump" ]; then
            echo "$label_names" | grep -qx "minor" && bump="minor" || true
          fi
          if [ -z "$bump" ]; then
            echo "$label_names" | grep -qx "patch" && bump="patch" || true
          fi

          if [ -z "$bump" ]; then
            echo "No version label (major/minor/patch) found; skipping release."
            echo "do_release=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Selected bump: $bump"
          echo "do_release=true" >> "$GITHUB_OUTPUT"
          echo "bump=$bump" >> "$GITHUB_OUTPUT"

      - name: Stop (no label)
        if: steps.decide.outputs.do_release != 'true'
        run: echo "No major/minor/patch label found; skipping."

      - name: Install Rust
        if: steps.decide.outputs.do_release == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Cargo cache
        if: steps.decide.outputs.do_release == 'true'
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-edit
        if: steps.decide.outputs.do_release == 'true'
        run: cargo install cargo-edit --locked

      - name: Bump version
        if: steps.decide.outputs.do_release == 'true'
        run: cargo set-version --bump ${{ steps.decide.outputs.bump }}

      - name: Read version
        id: version
        if: steps.decide.outputs.do_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          version="$(cargo metadata --no-deps --format-version 1 \
            | python -c 'import json,sys; print(json.load(sys.stdin)["packages"][0]["version"])')"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=v$version" >> "$GITHUB_OUTPUT"

      - name: Commit + open PR (unique branch name; no direct push to main)
        if: steps.decide.outputs.do_release == 'true'
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Safety: if there are no changes, bail.
          if git diff --quiet; then
            echo "No version changes detected after bump; exiting."
            exit 0
          fi

          tag="${{ steps.version.outputs.tag }}"
          pr_number="${{ github.event.pull_request.number }}"
          run_id="${{ github.run_id }}"

          # Unique branch name prevents non-fast-forward collisions on reruns
          branch="chore/release-${tag}-pr${pr_number}-run${run_id}"

          git checkout -b "$branch"
          git add Cargo.toml Cargo.lock || true
          git commit -m "chore(release): ${tag}"
          git push -u origin "$branch"

          pr_url="$(gh pr create \
            --base main \
            --head "$branch" \
            --title "chore(release): ${tag}" \
            --body "Automated version bump for ${tag} (from PR #${pr_number}).")"

          echo "Opened bump PR: $pr_url"

          # Best-effort: enable auto-merge (will fail if not enabled in repo settings)
          gh pr merge --auto --merge "$pr_url" || true
